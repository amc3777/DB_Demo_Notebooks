# yaml-language-server: $schema=bundle-settings-schema.json
resources:

  jobs:
    ml-workflow-job:

      name: ml-workflow-job
      job_clusters:

        - job_cluster_key: photon-cluster
          new_cluster:
            spark_version: 13.3.x-photon-scala2.12
            node_type_id: n2-highmem-4
            num_workers: 1
            gcp_attributes:
              google_service_account: fe-prod-general-sa@fe-prod-dbx.iam.gserviceaccount.com
            data_security_mode: SINGLE_USER
            single_user_name: andrew.cooley@databricks.com

        - job_cluster_key: gpu-node
          new_cluster:
            spark_version: 13.3.x-gpu-ml-scala2.12
            node_type_id: a2-highgpu-1g
            num_workers: 0
            spark_conf:
              spark.master: local[*, 4]
            gcp_attributes:
              google_service_account: fe-prod-general-sa@fe-prod-dbx.iam.gserviceaccount.com
            data_security_mode: SINGLE_USER
            single_user_name: andrew.cooley@databricks.com

        - job_cluster_key: automl-cluster
          new_cluster:
            spark_version: 13.3.x-cpu-ml-scala2.12
            node_type_id: n2-highmem-4
            num_workers: 4
            gcp_attributes:
              google_service_account: fe-prod-general-sa@fe-prod-dbx.iam.gserviceaccount.com
            data_security_mode: SINGLE_USER
            single_user_name: andrew.cooley@databricks.com

        - job_cluster_key: cpu-node
          new_cluster:
            spark_version: 13.3.x-cpu-ml-scala2.12
            node_type_id: n2-highmem-4
            num_workers: 0
            spark_conf:
              spark.master: local[*, 4]
            gcp_attributes:
              google_service_account: fe-prod-general-sa@fe-prod-dbx.iam.gserviceaccount.com
            data_security_mode: SINGLE_USER
            single_user_name: andrew.cooley@databricks.com

      tasks:
        - task_key: 01-bq-load-transform-save-task
          job_cluster_key: photon-cluster
          spark_python_task:
            python_file: ./01_bq_load_transform_save.py

        - task_key: 02a-train-mlp-model-task
          depends_on:
            - task_key: 01-bq-load-transform-save-task
          job_cluster_key: gpu-node
          spark_python_task:
            python_file: ./02a_train_mlp_model.py

        - task_key: 02b-train-automl-model-task
          depends_on:
            - task_key: 01-bq-load-transform-save-task
          job_cluster_key: automl-cluster
          spark_python_task:
            python_file: ./02b_train_automl_model.py

        - task_key: 03-eval-models-task
          depends_on:
            - task_key: 02a-train-mlp-model-task
            - task_key: 02b-train-automl-model-task
          job_cluster_key: cpu-node
          spark_python_task:
            python_file: ./03_eval_models.py

        - task_key: 04-deploy-best-model-task
          depends_on:
            - task_key: 03-eval-models-task
          job_cluster_key: cpu-node
          spark_python_task:
            python_file: ./04_deploy_best_model.py